<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>GoldCred — Catálogo de Veículos</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0a0a0a; --card:#111113; --muted:#c9c5b8; --text:#fffaf0;
    --brandStart:#503d29; --brandEnd:#d0ab5a;
    --chip:#1a1a1d;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:var(--text);
    /* subtle vignette + brand gradient glow */
    background:
      radial-gradient(900px 560px at 12% -10%, color-mix(in oklab, var(--brandEnd) 18%, transparent) 0%, transparent 60%),
      radial-gradient(1000px 700px at 90% 0%, color-mix(in oklab, var(--brandStart) 16%, transparent) 0%, transparent 70%),
      #0a0a0a;
  }
  a{color:inherit; text-decoration:none}
  .container{max-width:1200px; margin:0 auto; padding:20px}
  header{
    position:sticky; top:0; z-index:10; backdrop-filter:saturate(140%) blur(8px);
    background:
      linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.35)),
      linear-gradient(135deg, var(--brandStart), var(--brandEnd));
    border-bottom:1px solid color-mix(in oklab, var(--brandEnd) 35%, transparent);
  }
  .nav{display:flex; gap:16px; align-items:center; justify-content:space-between; padding:14px 20px}
  .logo{display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.3px}
  .logo-img{width:44px; height:44px; border-radius:12px; object-fit:cover; box-shadow:0 0 0 2px color-mix(in oklab, var(--brandEnd) 40%, transparent)}
  .badge{
    background:linear-gradient(135deg, color-mix(in oklab, var(--brandStart) 25%, transparent), color-mix(in oklab, var(--brandEnd) 25%, transparent));
    border:1px solid color-mix(in oklab, var(--brandEnd) 45%, transparent); color:#fff6d5; padding:4px 8px; border-radius:999px; font-size:12px
  }
  .actions{display:flex; gap:10px; align-items:center}
  .btn{
    border:1px solid color-mix(in oklab, var(--brandEnd) 35%, transparent); background:#141414; color:var(--text);
    padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer
  }
  .btn.primary{background:linear-gradient(135deg,var(--brandStart),var(--brandEnd)); border:none; color:#141006}
  .btn.ghost{background:transparent}

  .filters{margin-top:18px; display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
  .card{background:linear-gradient(180deg,#121213,#0d0d0e); border:1px solid color-mix(in oklab, var(--brandEnd) 25%, transparent);
        border-radius:16px; box-shadow:0 8px 30px rgba(0,0,0,.35)}
  .card.pad{padding:14px}
  .ctrl{display:flex; flex-direction:column; gap:6px}
  .ctrl label{font-size:12px; color:var(--muted)}
  .ctrl input,.ctrl select,.ctrl textarea{width:100%; background:#0e0e0f; color:var(--text);
       border:1px solid color-mix(in oklab, var(--brandEnd) 28%, transparent); border-radius:10px; padding:10px 12px; outline:none}
  .ctrl input::placeholder{color:#a79c7b}

  .grid{margin-top:18px; display:grid; grid-template-columns:repeat(12,1fr); gap:16px}
  .vehicle{grid-column:span 4; display:flex; flex-direction:column; overflow:hidden; position:relative}
  .vehicle .img{position:relative; padding-top:62%; overflow:hidden; background:#0b0d12}
  .vehicle .img img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transition:transform .5s ease}
  .vehicle:hover .img img{transform:scale(1.04)}
  .vehicle .content{padding:14px; display:flex; flex-direction:column; gap:10px}
  .title{font-weight:700}
  .meta{display:flex; flex-wrap:wrap; gap:8px}
  .chip{background:var(--chip); color:#f3e7b3; padding:6px 10px; border:1px solid color-mix(in oklab, var(--brandEnd) 18%, transparent); border-radius:999px; font-size:12px}
  .price{font-weight:800; font-size:20px; background:linear-gradient(135deg, var(--brandStart), var(--brandEnd)); -webkit-background-clip:text; background-clip:text; color:transparent}
  .topline{display:flex; gap:10px; align-items:center; justify-content:space-between}
  .flag{position:absolute; top:10px; left:10px; background:linear-gradient(135deg, var(--brandEnd), var(--brandStart)); color:#1a1200;
        padding:6px 10px; font-weight:800; border-radius:999px; font-size:12px; border:1px solid rgba(0,0,0,.2)}
  .fav{position:absolute; top:10px; right:10px; background:rgba(0,0,0,.5); border:1px solid color-mix(in oklab, var(--brandEnd) 35%, transparent);
       width:36px; height:36px; display:grid; place-items:center; border-radius:10px; cursor:pointer}

  .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between}
  .pagination{display:flex; gap:8px; align-items:center; justify-content:center; margin:20px 0}
  .page-btn{background:#141414; color:var(--text); border:1px solid color-mix(in oklab, var(--brandEnd) 25%, transparent); padding:8px 12px; border-radius:10px; cursor:pointer}
  .page-btn[disabled]{opacity:.5; cursor:not-allowed}

  /* Modal geral */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.76); display:none; align-items:center; justify-content:center; padding:20px}
  .modal.open{display:flex}
  .modal-card{width:min(1020px,94vw); max-height:92vh; overflow:auto; border-radius:16px}
  .modal .head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid color-mix(in oklab, var(--brandEnd) 28%, transparent)}
  .modal .body{padding:16px; display:grid; grid-template-columns:1fr 1fr; gap:16px}
  .thumb{aspect-ratio:16/10; background:#0f1111; border-radius:12px; overflow:hidden}
  .thumb img{width:100%; height:100%; object-fit:cover}
  .specs{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .spec{background:#0f0f10; border:1px solid color-mix(in oklab, var(--brandEnd) 20%, transparent); padding:10px 12px; border-radius:10px}
  .kv{display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:6px}
  .kv .item{display:flex; gap:8px; align-items:center; background:#0f0f10; border:1px solid color-mix(in oklab, var(--brandEnd) 18%, transparent); padding:8px 10px; border-radius:10px; font-size:12px}
  .kv .item .k{color:var(--muted)}
  .kv .item .v{font-weight:700; color:#f7e7b0}

  /* Slider do modal */
  .slider{position:relative}
  .slider .viewport{aspect-ratio:16/10; background:#0f1111; overflow:hidden; border-radius:12px; border:1px solid color-mix(in oklab, var(--brandEnd) 25%, transparent)}
  .slider .viewport img{width:100%; height:100%; object-fit:cover; display:block}
  .slider .nav{position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between; pointer-events:none}
  .slider .nav button{pointer-events:auto; background:rgba(0,0,0,.45); border:1px solid color-mix(in oklab, var(--brandEnd) 45%, transparent);
    width:38px; height:38px; border-radius:50%; cursor:pointer; font-weight:900; color:#f9e9b8}
  .thumbs{display:flex; gap:8px; margin-top:10px; overflow:auto; padding-bottom:4px}
  .thumbs img{width:72px; height:56px; object-fit:cover; border-radius:8px; border:2px solid transparent; cursor:pointer}
  .thumbs img.active{border-color:color-mix(in oklab, var(--brandEnd) 70%, var(--brandStart) 30%)}

  /* Modal cadastro */
  .modal-sm .modal-card{width:min(720px,95vw)}
  .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .form-grid .full{grid-column:span 2}

  @media (max-width:1024px){ .vehicle{grid-column:span 6} .modal .body{grid-template-columns:1fr} }
  @media (max-width:640px){
    .filters{grid-template-columns:1fr 1fr}
    .vehicle{grid-column:span 12}
    .form-grid{grid-template-columns:1fr}
    .form-grid .full{grid-column:span 1}
  }

.btn.danger{ background:#b91c1c !important; color:#fff !important; border:none !important; }
.btn.danger:hover{ filter:brightness(0.95); }
</style>
</head>
<body>
<div id="toastArea" style="position:fixed;inset:auto 12px 12px auto;z-index:9999"></div>
<header>
  <div class="nav container">
    <div class="logo">
      <img class="logo-img" src="Logo GoldCred.png" alt="GoldCred">
      <div>
        <div style="font-size:15px; color:var(--muted); line-height:1">Catálogo</div>
        <div style="font-size:18px; line-height:1; font-weight:800">GoldCred</div>
      </div>
      <span class="badge">Gold</span>
    </div>
    <div class="actions">
      <button class="btn" id="cadBtn">Cadastrar veículo</button>
      <button class="btn" id="resetBtn">Limpar filtros</button>
      <!-- Removidos: Importar JSON e Falar no WhatsApp -->
    </div>
  </div>
</header>

<main class="container">
  <div class="toolbar">
    <div style="display:flex; gap:10px; align-items:center; flex:1;">
      <div class="card pad" style="flex:1;">
        <div class="ctrl">
          <label>Busca por palavra-chave</label>
          <input id="q" type="search" placeholder="Ex.: Corolla 2020, automático, branco…" />
        </div>
      </div>
      <div class="card pad" style="width:210px;">
        <div class="ctrl">
          <label>Ordenar por</label>
          <select id="sort">
            <option value="recent">Mais recentes</option>
            <option value="preco_asc">Menor preço</option>
            <option value="preco_desc">Maior preço</option>
            <option value="ano_desc">Ano mais novo</option>
            <option value="ano_asc">Ano mais antigo</option>
            <option value="km_asc">Menor km</option>
            <option value="km_desc">Maior km</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros completos -->
  <section class="filters">
    <div class="card pad ctrl" style="grid-column:span 3">
      <label>Marca</label><select id="f-marca"></select>
    </div>
    <div class="card pad ctrl" style="grid-column:span 3">
      <label>Modelo</label><select id="f-modelo"></select>
    </div>
    <div class="card pad ctrl" style="grid-column:span 2">
      <label>Ano mín.</label><select id="f-ano-min"></select>
    </div>
    <div class="card pad ctrl" style="grid-column:span 2">
      <label>Ano máx.</label><select id="f-ano-max"></select>
    </div>
    <div class="card pad ctrl" style="grid-column:span 2">
      <label>Câmbio</label><select id="f-cambio"></select>
    </div>
    <div class="card pad ctrl" style="grid-column:span 2">
      <label>Combustível</label><select id="f-comb"></select>
    </div>
    <div class="card pad ctrl" style="grid-column:span 2">
      <label>Carroceria</label><select id="f-body"></select>
    </div>
    <div class="card pad ctrl" style="grid-column:span 2">
      <label>Preço mín. (R$)</label><input id="f-pmin" type="number" min="0" step="1000" placeholder="0" />
    </div>
    <div class="card pad ctrl" style="grid-column:span 2">
      <label>Preço máx. (R$)</label><input id="f-pmax" type="number" min="0" step="1000" placeholder="—" />
    </div>
    <div class="card pad ctrl" style="grid-column:span 2">
      <label>Garagem</label><select id="f-garagem"></select>
    </div>
  </section>

  <section id="grid" class="grid"></section>
  <div class="pagination" id="pagination"></div>
</main>

<!-- Modal Detalhes com slider e TODAS as características -->
<div class="modal" id="modal">
  <div class="modal-card card">
    <div class="head">
      <div style="font-weight:800; font-size:18px" id="m-title">Detalhes</div>
      <button class="btn" id="m-close">Fechar</button>
    </div>
    <div class="body">
      <div>
        <div class="slider">
          <div class="viewport"><img id="slideImg" alt=""></div>
          <div class="nav">
            <button id="prev" aria-label="Anterior">‹</button>
            <button id="next" aria-label="Próxima">›</button>
          </div>
        </div>
        <div class="thumbs" id="thumbs" style="margin-top:10px"></div>
        <div style="margin-top:8px; color:#e9d37a; font-weight:700"><span id="countPos">1</span>/<span id="countTotal">1</span></div>
      </div>
      <div style="display:flex; flex-direction:column; gap:12px">
        <div class="price" id="m-price">—</div>
        <div class="meta" id="m-meta"></div>
        <div class="kv" id="m-kv"></div>
        <div style="color:var(--muted); white-space:pre-wrap" id="m-desc"></div>
        <div class="specs" id="m-specs"></div>
        <div style="display:flex; gap:10px">
          <button class="btn" id="m-copiar">Copiar link do anúncio</button>
        </div>
      
  <div class="foot" id="m-actions" style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px">
    <button class="btn danger" id="m-excluir">Remover</button>
    <button class="btn" id="m-editar">Editar</button>
  </div>
</div>
    </div>
  </div>
</div>

<!-- Modal Cadastro (com upload de imagens) -->
<div class="modal modal-sm" id="cadModal">
  <div class="modal-card card">
    <div class="head">
      <div style="font-weight:800; font-size:18px">Cadastrar veículo</div>
      <button class="btn" id="cadClose">Fechar</button>
    </div>
    <div class="body">
      <form id="cadForm" class="form-grid">
        <div class="ctrl full"><label>Título</label><input name="titulo" required /></div>
        <div class="ctrl"><label>Marca</label><input name="marca" required /></div>
        <div class="ctrl"><label>Modelo</label><input name="modelo" required /></div>
        <div class="ctrl"><label>Carroceria</label><input name="carroceria" placeholder="Sedan, SUV, Hatch…" /></div>
        <div class="ctrl"><label>Garagem</label><input name="garagem" placeholder="Unidade / Box" /></div>

        <div class="ctrl"><label>Ano</label><input name="ano" type="number" required /></div>
        <div class="ctrl"><label>KM</label><input name="km" type="number" required /></div>
        <div class="ctrl"><label>Câmbio</label><input name="cambio" placeholder="Automático, Manual, CVT…" /></div>
        <div class="ctrl"><label>Combustível</label><input name="combustivel" placeholder="Flex, Gasolina, Diesel…" /></div>

        <div class="ctrl"><label>Cor</label><input name="cor" /></div>
        <div class="ctrl"><label>Portas</label><input name="portas" type="number" /></div>
        <div class="ctrl"><label>Preço (R$)</label><input name="preco" type="number" required /></div>
        <div class="ctrl full"><label>Descrição</label><textarea name="descricao" rows="3"></textarea></div>

        <div class="ctrl full">
          <label>Imagens (arquivos) — múltiplas</label>
          <input type="file" id="imgFiles" accept="image/*" multiple>
          <div style="font-size:12px; color:var(--muted)">As fotos serão armazenadas localmente (base64) no seu navegador.</div>
        </div>
        <div class="ctrl full">
          <label>Ou adicionar por URL (opcional, separado por vírgula)</label>
          <input name="imgsUrl" placeholder="https://.../foto1.jpg, https://.../foto2.jpg" />
        </div>
        <div class="ctrl"><label>Destaque</label>
          <select name="destaque"><option value="false">Não</option><option value="true">Sim</option></select>
        </div>
        <div class="ctrl"><label>&nbsp;</label><button class="btn primary" type="submit">Salvar</button></div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2">
function toast(msg){
  const t=document.createElement('div');
  t.textContent=msg;
  t.style.cssText='background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 4px 18px rgba(0,0,0,.35);margin-top:8px;max-width:360px;font:500 14px/1.3 system-ui';
  const a=document.getElementById('toastArea'); a.appendChild(t);
  setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(5px)'; setTimeout(()=>t.remove(),400); }, 2600);
}
</script>
<script>

// === Supabase Client ===
const SUPABASE_URL = "https://aabomakkcvgdkmljnzbr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhYm9tYWtrY3ZnZGttbGpuemJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxOTA0OTUsImV4cCI6MjA3MDc2NjQ5NX0.3_b7qIANnb9TNu-n0ZYJ_f3gMlbX2oU_lbGcgE5IUXE";
const sb = (window.supabase && window.supabase.createClient) ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
let STORAGE_OK = true; // se falhar uma vez, desativamos novas tentativas nesta sessão

const ITENS_POR_PAGINA = 9;
const LS_INV_KEY = "goldcred.inv.v2";

const seed = []; // fallback vazio, usaremos Supabase

const $ = s => document.querySelector(s);
const fmtBRL = v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v);
const fmtKM = km => new Intl.NumberFormat('pt-BR').format(km) + ' km';

let veiculos = [];

function loadInventarioLocal(){
  try{
    const data = localStorage.getItem(LS_INV_KEY);
    if(!data){ localStorage.setItem(LS_INV_KEY, JSON.stringify(seed)); return seed.slice(); }
    try { return JSON.parse(data); } catch (e) { return seed.slice(); }
  }catch(e){ return []; }
}

// === Fetch inventory from Supabase ===
async function fetchInventario(){
  try{
    if(sb){
      const { data, error } = await sb.from('vehicles').select('*').order('criadoEm', { ascending:false });
      if(error){ console.error('Supabase select error:', error); veiculos = []; }
      else { veiculos = Array.isArray(data) ? data : []; }
    } else {
      veiculos = loadInventarioLocal();
    }
  }catch(e){ console.error('fetchInventario exception:', e); veiculos = []; }
  buildFilters(); paginaAtual=1; render();
}
document.addEventListener('DOMContentLoaded', ()=>{ fetchInventario(); });

// Realtime sync
if(sb && sb.channel){
  const ch = sb.channel('realtime:vehicles')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'vehicles' }, (payload)=>{
      try{
        if(payload.eventType==='INSERT'){ const v=payload.new; if(!veiculos.find(x=>x.id===v.id)) veiculos.unshift(v); }
        if(payload.eventType==='UPDATE'){ const v=payload.new; const i=veiculos.findIndex(x=>x.id===v.id); if(i>-1) veiculos[i]=v; }
        if(payload.eventType==='DELETE'){ const v=payload.old; const i=veiculos.findIndex(x=>x.id===v.id); if(i>-1) veiculos.splice(i,1); }
        buildFilters(); render();
      }catch(e){ console.warn('Realtime handler error', e); }
    }).subscribe();
}

// === FILTROS ===
function unique(a){ return [...new Set(a.filter(Boolean))]; }
function anosRange(){
  if(!veiculos.length) return [];
  const min = Math.min(...veiculos.map(v=>v.ano||9999)), max = Math.max(...veiculos.map(v=>v.ano||0));
  const arr=[]; for(let y=max; y>=min; y--) arr.push(y); return arr;
}
function fillSelect(el, values, placeholder='Todos'){
  if(!el) return;
  el.innerHTML='';
  const o0=document.createElement('option'); o0.value=''; o0.textContent=placeholder; el.appendChild(o0);
  values.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o); });
}
function buildFilters(){
  fillSelect($('#f-marca'), unique(veiculos.map(v=>v.marca)).sort(),'Todas');
  fillSelect($('#f-modelo'), unique(veiculos.map(v=>v.modelo)).sort(),'Todos');
  const anos = anosRange();
  fillSelect($('#f-ano-min'), anos,'—');
  fillSelect($('#f-ano-max'), anos,'—');
  fillSelect($('#f-cambio'), unique(veiculos.map(v=>v.cambio)).sort(),'Todos');
  fillSelect($('#f-comb'), unique(veiculos.map(v=>v.combustivel)).sort(),'Todos');
  fillSelect($('#f-body'), unique(veiculos.map(v=>v.carroceria)).sort(),'Todas');
  fillSelect($('#f-garagem'), unique(veiculos.map(v=>v.garagem)).sort(),'Todas');
}

// === LISTA / RENDER ===
let paginaAtual = 1;

function aplicarFiltros(){
  const q = ($('#q')?.value||'').trim().toLowerCase();
  const marca=$('#f-marca')?.value||'', modelo=$('#f-modelo')?.value||'';
  const anoMin=parseInt(($('#f-ano-min')?.value||'0'),10), anoMax=parseInt(($('#f-ano-max')?.value||'9999'),10);
  const cambio=$('#f-cambio')?.value||'', comb=$('#f-comb')?.value||'', body=$('#f-body')?.value||'', gar=$('#f-garagem')?.value||'';
  const pmin=parseInt(($('#f-pmin')?.value||'0'),10), pmax=parseInt(($('#f-pmax')?.value||'999999999'),10);

  let lista = veiculos.filter(v=>{
    const texto=[v.titulo,v.marca,v.modelo,v.cor,v.carroceria,v.cambio,v.combustivel,v.garagem].join(' ').toLowerCase();
    const okQ = !q || texto.includes(q) || String(v.ano).includes(q) || String(v.km).includes(q);
    const okMarca=!marca||v.marca===marca, okModelo=!modelo||v.modelo===modelo, okAno=(v.ano||0)>=anoMin&&(v.ano||9999)<=anoMax;
    const okCam=!cambio||v.cambio===cambio, okComb=!comb||v.combustivel===comb, okBody=!body||v.carroceria===body, okGar=!gar||v.garagem===gar;
    const okPreco=(v.preco||0)>=pmin && (v.preco||0)<=pmax;
    return okQ&&okMarca&&okModelo&&okAno&&okCam&&okComb&&okBody&&okGar&&okPreco;
  });

  const sort = ($('#sort')?.value)||'recent';
  lista.sort((a,b)=>{
    if(sort==='recent') return new Date(b.criadoEm)-new Date(a.criadoEm);
    if(sort==='preco_asc') return (a.preco||0)-(b.preco||0);
    if(sort==='preco_desc') return (b.preco||0)-(a.preco||0);
    if(sort==='ano_desc') return (b.ano||0)-(a.ano||0);
    if(sort==='ano_asc') return (a.ano||0)-(b.ano||0);
    if(sort==='km_asc') return (a.km||0)-(b.km||0);
    if(sort==='km_desc') return (b.km||0)-(a.km||0);
    return 0;
  });
  return lista;
}

function cardVeiculo(v){
  const el=document.createElement('article'); el.className='vehicle card';
  el.innerHTML = `
    ${v.destaque?'<div class="flag">Destaque</div>':''}
    <div class="fav" title="Favoritar" data-id="${v.id}">❤</div>
    <a href="#" data-id="${v.id}" class="open-modal">
      <div class="img"><img src="${(v.imagens&&v.imagens[0])||''}" loading="lazy" alt="${v.titulo}"/></div>
    </a>
    <div class="content">
      <div class="topline">
        <div class="title">${v.titulo}</div>
        <div class="price">${fmtBRL(v.preco||0)} </div>
      </div>
      <div class="meta">
        <span class="chip">${v.ano||'—'}</span>
        <span class="chip">${fmtKM(v.km||0)}</span>
        <span class="chip">${v.cambio||''}</span>
        <span class="chip">${v.combustivel||''}</span>
        <span class="chip">${v.carroceria||''}</span>
        ${v.garagem?`<span class="chip">Garagem: ${v.garagem}</span>`:''}
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center">
        <button class="btn ghost open-modal" data-id="${v.id}">Detalhes</button>
      </div>
    </div>`;
  el.querySelectorAll('.open-modal').forEach(a=>a.addEventListener('click',ev=>{ev.preventDefault(); openModal(v.id);}));
  el.querySelector('.fav')?.addEventListener('click', (e)=>{ toggleFav(v.id, e.currentTarget); });
  updateFavIcon(v.id, el.querySelector('.fav'));
  return el;
}

function render(){
  const lista = aplicarFiltros();
  const total = lista.length;
  const maxPag = Math.max(1, Math.ceil(total/ITENS_POR_PAGINA));
  if(paginaAtual>maxPag) paginaAtual=maxPag;
  const ini=(paginaAtual-1)*ITENS_POR_PAGINA;
  const vis=lista.slice(ini, ini+ITENS_POR_PAGINA);

  const grid=$('#grid'); grid.innerHTML='';
  if(!vis.length) grid.innerHTML = `<div class="card pad" style="grid-column:span 12; text-align:center; padding:30px">Nenhum veículo encontrado.</div>`;
  vis.forEach(v=>grid.appendChild(cardVeiculo(v)));

  const pagEl=$('#pagination'); pagEl.innerHTML='';
  const mk=(t,on,dis=false)=>{const b=document.createElement('button'); b.className='page-btn'; b.textContent=t; b.disabled=dis; b.onclick=on; return b;}
  pagEl.appendChild(mk('⟨⟨',()=>{paginaAtual=1; render()}, paginaAtual===1));
  pagEl.appendChild(mk('⟨',()=>{paginaAtual=Math.max(1,paginaAtual-1); render()}, paginaAtual===1));
  const info=document.createElement('span'); info.style.opacity=.8; info.textContent=`Página ${paginaAtual} de ${maxPag} • ${total} veículos`; pagEl.appendChild(info);
  pagEl.appendChild(mk('⟩',()=>{paginaAtual=Math.min(maxPag,paginaAtual+1); render()}, paginaAtual===maxPag));
  pagEl.appendChild(mk('⟩⟩',()=>{paginaAtual=maxPag; render()}, paginaAtual===maxPag));
}

// === MODAL / SLIDER ===
const mTitle=$('#m-title'), mPrice=$('#m-price'), mMeta=$('#m-meta'), mDesc=$('#m-desc'), mSpecs=$('#m-specs'), mKV=$('#m-kv');
const modal=$('#modal'), mClose=$('#m-close'), slideImg=$('#slideImg'), thumbs=$('#thumbs'), prev=$('#prev'), next=$('#next');

const countPos=$('#countPos'), countTotal=$('#countTotal');
let slider = { imgs:[], idx:0 };

function openModal(id){
  const v = veiculos.find(x=>x.id===id); if(!v) return;
  mTitle.textContent = v.titulo||'';
  mPrice.textContent = fmtBRL(v.preco||0);
  mDesc.textContent = v.descricao || '';

  mMeta.innerHTML = [v.marca,v.modelo,v.ano && ('Ano '+v.ano), fmtKM(v.km||0), v.cambio, v.combustivel, v.carroceria]
    .filter(Boolean).map(x=>`<span class="chip">${x}</span>`).join('');

  const kv = [
    ['Marca', v.marca], ['Modelo', v.modelo], ['Carroceria', v.carroceria], ['Ano', v.ano],
    ['KM rodado', (v.km||0).toLocaleString('pt-BR') + ' km'], ['Câmbio', v.cambio], ['Combustível', v.combustivel],
    ['Cor', v.cor], ['Portas', v.portas], ['Garagem', v.garagem], ['ID', v.id], ['Preço', fmtBRL(v.preco||0)]
  ];
  mKV.innerHTML = kv.filter(x=>x[1]!==undefined && x[1]!==null && x[1]!=='' ).map(([k,val])=>`<div class="item"><span class="k">${k}:</span> <span class="v">${val}</span></div>`).join('');

  initSlider((v.imagens && v.imagens.length) ? v.imagens : ['']);
  modal.dataset.vid = v.id;
  modal.classList.add('open'); history.replaceState(null,'','#'+encodeURIComponent(v.id));
}

function initSlider(imgs){
  slider.imgs = imgs.slice(); slider.idx=0; thumbs.innerHTML='';
  updateSlide();
  slider.imgs.forEach((src,i)=>{ const t=document.createElement('img'); t.src=src; if(i===0) t.classList.add('active'); t.addEventListener('click', ()=>{slider.idx=i; updateSlide()}); thumbs.appendChild(t); });
  prev.onclick = ()=>{ slider.idx = (slider.idx - 1 + slider.imgs.length) % slider.imgs.length; updateSlide(); };
  next.onclick = ()=>{ slider.idx = (slider.idx + 1) % slider.imgs.length; updateSlide(); };
  let sx=0, dx=0; slideImg.addEventListener('touchstart', (e)=>{ sx=e.touches[0].clientX; dx=0; }, {passive:true});
  slideImg.addEventListener('touchmove', (e)=>{ dx=e.touches[0].clientX - sx; }, {passive:true});
  slideImg.addEventListener('touchend', ()=>{ if(Math.abs(dx)>40){ dx<0?next.onclick():prev.onclick(); } sx=dx=0; }, {passive:true});
  document.onkeydown = (ev)=>{ if(!modal.classList.contains('open')) return; if(ev.key==='ArrowLeft') prev.onclick(); if(ev.key==='ArrowRight') next.onclick(); if(ev.key==='Escape') closeModal(); };
}
function updateSlide(){
  slideImg.src = slider.imgs[slider.idx] || '';
  countPos.textContent = String(slider.idx+1);
  countTotal.textContent = String(slider.imgs.length);
  [...thumbs.children].forEach((n,i)=>n.classList.toggle('active', i===slider.idx));
}
function closeModal(){ modal.classList.remove('open'); }
mClose.addEventListener('click', closeModal);
modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });
window.addEventListener('load', ()=>{ const id=decodeURIComponent(location.hash.slice(1)||''); if(id){ setTimeout(()=>openModal(id), 200); } });

// === FAVORITOS ===
function getFavs(){ try{ return JSON.parse(localStorage.getItem('favs')||'[]') } catch(e) { return [] } }
function setFavs(x){ localStorage.setItem('favs', JSON.stringify(x)); }
function toggleFav(id, el){ const s=new Set(getFavs()); s.has(id)?s.delete(id):s.add(id); setFavs([...s]); updateFavIcon(id, el); }
function updateFavIcon(id, el){ const on = new Set(getFavs()).has(id); if(el) el.style.background = on?'rgba(208,171,90,1)':'rgba(0,0,0,.5)'; }

// === CADASTRO / EDIÇÃO ===
const cadBtn = document.getElementById('cadBtn');
const cadClose = document.getElementById('cadClose');
const cadModal = document.getElementById('cadModal');
const cadTitle = document.getElementById('cadTitle');
let editingId = null;

cadBtn.addEventListener('click', ()=> cadModal.classList.add('open'));
cadClose.addEventListener('click', ()=> { 
  cadModal.classList.remove('open'); 
  editingId=null; if(cadTitle) cadTitle.textContent='Cadastrar veículo';
  const submitBtn = document.querySelector('#cadForm button[type="submit"]'); if(submitBtn) submitBtn.textContent='Salvar';
});

// Botões do modal de detalhes

// Deleção reutilizável (card ou modal)
async function deleteVehicle(id){
  if(!id){ alert('Veículo não identificado.'); return; }
  if(!confirm('Tem certeza que deseja excluir este veículo?')) return;
  try{
    if(typeof sb !== 'undefined' && sb){
      const { error } = await sb.from('vehicles').delete().eq('id', id);
      if(error){ console.error('Erro ao excluir no banco:', error); alert('Falha ao excluir no banco.'); return; }
    }
    const idx = veiculos.findIndex(x=>x.id===id);
    if(idx>-1){ veiculos.splice(idx,1); }
    if(document.getElementById('modal')?.classList.contains('open')){
      const openedId = document.getElementById('modal').dataset.vid;
      if(openedId === id) document.getElementById('modal').classList.remove('open');
    }
    render();
  }catch(e){
    console.error(e);
    alert('Erro ao excluir.');
  }
}

const mExcluir = document.getElementById('m-excluir');
if(mExcluir){
  mExcluir.onclick = ()=>{
    const id = modal.dataset.vid;
    deleteVehicle(id);
  };
}

const mEditar = document.getElementById('m-editar');
if(mEditar){
  mEditar.onclick = ()=>{
    const id = modal.dataset.vid;
    const v = veiculos.find(x=>x.id===id);
    if(!v){ alert('Veículo não encontrado.'); return; }
    editingId = v.id;
    if(cadTitle) cadTitle.textContent = 'Editar veículo';
    const f = document.getElementById('cadForm');
    f.titulo.value = v.titulo || '';
    if(f.marca) f.marca.value = v.marca || 'Outro';
    f.modelo.value = v.modelo || '';
    if(f.carroceria) f.carroceria.value = v.carroceria || 'Outro';
    f.garagem.value = v.garagem || '';
    f.ano.value = v.ano || '';
    f.km.value = v.km || '';
    if(f.cambio) f.cambio.value = v.cambio || 'Outro';
    if(f.combustivel) f.combustivel.value = v.combustivel || 'Outro';
    f.cor.value = v.cor || '';
    f.portas.value = v.portas || '';
    f.preco.value = v.preco || '';
    f.descricao.value = v.descricao || '';
    const urlField = f.querySelector('input[name="imgsUrl"]'); if(urlField) urlField.value = '';
    modal.classList.remove('open');
    cadModal.classList.add('open');
    const submitBtn = f.querySelector('button[type="submit"]'); if(submitBtn) submitBtn.textContent = 'Salvar alterações';
  };
}

// Submit: insert/update
document.getElementById('cadForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = e.target;
  const data = Object.fromEntries(new FormData(f).entries());

  const filesEl = document.getElementById('imgFiles');
  const files = filesEl && filesEl.files ? Array.from(filesEl.files) : [];
  let uploadedUrls = [];
  if (files.length && sb) {
    for (const file of files) {
      try{
        const path = `${Date.now()}-${Math.random().toString(36).slice(2)}-${file.name}`;
        const up = await sb.storage.from('vehicles').upload(path, file, { upsert:true, contentType:file.type });
        if(up.error) throw up.error;
        const pub = sb.storage.from('vehicles').getPublicUrl(path);
        if(pub.error) throw pub.error;
        uploadedUrls.push(pub.data.publicUrl);
      }catch(err){
        const fr = new FileReader();
        const url = await new Promise((res,rej)=>{ fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
        uploadedUrls.push(url);
      }
    }
  } else if (files.length){
    if(!STORAGE_OK) toast('Falha ao enviar fotos ao Storage — usando fallback local.');
    uploadedUrls = await Promise.all(files.map(file=> new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file);})));
  }
  const urlImgs = (data.imgsUrl||'').split(',').map(s=>s.trim()).filter(Boolean);
  let imagens = [...uploadedUrls, ...urlImgs];

  if(editingId){
    const antigo = veiculos.find(x=>x.id===editingId) || {};
    if(!imagens.length) imagens = antigo.imagens || [];
    const atual = {
      titulo:data.titulo||'Sem título', marca:data.marca||'', modelo:data.modelo||'',
      ano:parseInt(data.ano||'0',10)||null, km:parseInt(data.km||'0',10)||0,
      cambio:data.cambio||'', combustivel:data.combustivel||'',
      cor:data.cor||'', portas:parseInt(data.portas||'0',10)||null,
      carroceria:data.carroceria||'', preco:parseInt(data.preco||'0',10)||0,
      descricao:data.descricao||'', imagens, destaque:String(data.destaque)==='true', garagem:data.garagem||''
    };
    try{
      if(sb){ const { error } = await sb.from('vehicles').update(atual).eq('id', editingId); if(error) throw error; }
      const i = veiculos.findIndex(x=>x.id===editingId); if(i>-1) veiculos[i] = { ...(veiculos[i]||{}), ...atual, id: editingId };
    }catch(err){ console.error('Update error:', err); alert('Falha ao atualizar.'); }
    editingId=null; if(cadTitle) cadTitle.textContent='Cadastrar veículo'; const submitBtn=f.querySelector('button[type="submit"]'); if(submitBtn) submitBtn.textContent='Salvar';
    cadModal.classList.remove('open'); f.reset(); render(); return;
  }

  if(!imagens.length){ alert('Adicione ao menos uma imagem (arquivo ou URL).'); return; }
  const novo = {
    id: (data.titulo||'novo').toLowerCase().replace(/[^a-z0-9]+/g,'-') + '-' + Date.now().toString(36),
    titulo:data.titulo||'Sem título', marca:data.marca||'', modelo:data.modelo||'',
    ano:parseInt(data.ano||'0',10)||null, km:parseInt(data.km||'0',10)||0,
    cambio:data.cambio||'', combustivel:data.combustivel||'',
    cor:data.cor||'', portas:parseInt(data.portas||'0',10)||null,
    carroceria:data.carroceria||'', preco:parseInt(data.preco||'0',10)||0,
    descricao:data.descricao||'', imagens, destaque:String(data.destaque)==='true',
    garagem:data.garagem||'', criadoEm:new Date().toISOString()
  };
  if(sb){
    try{
      const { error } = await sb.from('vehicles').insert(novo);
      if(error){ console.error('Insert error:', error); alert('Falha ao cadastrar no banco.'); return; }
    }catch(e){ console.error('Insert exception:', e); alert('Erro ao cadastrar no banco.'); return; }
  }
  veiculos.unshift(novo);
  buildFilters(); paginaAtual=1; render();
  f.reset(); cadModal.classList.remove('open');
});

// === EVENTOS DE FILTRO ===
['q','sort','f-marca','f-modelo','f-ano-min','f-ano-max','f-cambio','f-comb','f-body','f-garagem','f-pmin','f-pmax']
  .forEach(id=> { const el=document.getElementById(id); if(el) el.addEventListener('input', ()=>{ paginaAtual=1; render(); }); });

document.getElementById('resetBtn').addEventListener('click', ()=>{
  ['q','f-marca','f-modelo','f-ano-min','f-ano-max','f-cambio','f-comb','f-body','f-garagem','f-pmin','f-pmax'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  const srt=document.getElementById('sort'); if(srt) srt.value='recent';
  paginaAtual=1; render();
});

</script>
</body>
</html>
